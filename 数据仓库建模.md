数据仓库建模方法理论⭐️⭐️⭐️⭐️⭐️

HBase (JavaAPl操作 +Phoenix）



数仓分层理论
星型模型、雪花模型、逆三泛式建模
连链表通用模板、开链，闭链，卡拉链
数据核验原理



# 前言

## 为什么构建数据仓库

Java Web为什么需要大数据

**数据存储有瓶颈**：抖音平台的点赞、评论、私信、广告、浏览记录、商品数据、交易订单这些很多属于日志数据，而**关系型数据库一般不存储日志数据**（关系型数据库一般用于频繁的增删改查，而且存储日志数据导致数据量太大，MySQL存不下）

- 关系型数据库没有这种日志数据，无法进行用户行为的分析

**数据存储在互不兼容的系统中**：企业不同的业务平台系统，由于用户地域不同等原因，存放在不同数据库和不同类型的数据库中

**海量数据计算（查询）有瓶颈**：电影网站榜单、周月度排行，mysql不行

**实时场景计算有瓶颈**：实时交易数据，实时人数统计

**数据挖掘（推荐算法等）有瓶颈**：电商平台商品推荐实现



数据仓库是大数据平台的基础

数据治理：将发散在各个web系统里的数据，进行集中和规范化，从而挖掘数据中的价值



## 数据库三范式

第一范式1NF：原子性，字段不可分

>表的字段，便于统计
>
><img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723134222812.png" alt="image-20230723134222812" style="zoom: 25%;" />

第二范式2NF：有主键PK，**非主键字段依赖主键**

> 减少冗余
>
> <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723134150424.png" alt="image-20230723134150424" style="zoom: 25%;" />

第三范式3NF：非主键字段不能相互依赖

> <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723134550843.png" alt="image-20230723134550843" style="zoom:25%;" />

范式级别越高，拆出来的表越多，有时候允许一定的数据冗余



## ER实体关系模型

用来为数据库设计表

> 1.抽象实体，2. 找出实体的关系，3. 找出实体的属性， 4. 画出ER关系图， 5. 设计数据库表，完善PK，FK字段
>
> <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723135251270.png" alt="image-20230723135251270" style="zoom:50%;" />

# 数据仓库

## 定义

DW（data warehouse）：数据仓库是面向主题的、集成的（非简单的数据堆积）、相对稳定的、反应历史变化的数据集合,数仓中的数据是有组织有结构的存储数据集合,用于对管理决策过程的支持。

<img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723145630716.png" alt="image-20230723145630716" style="zoom:33%;" />

- 面向主题：要分析用户，需要用户的贷款信息、存款信息、风险评估信息，来自不同业务库的表数据

  <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723143641251.png" alt="image-20230723143641251" style="zoom:50%;" />

- 集成：不同字段的实体需要消歧、一致性

  - 数据仓库中不同系统对于性别字段，有不同的描述，如性别=男，Gender=man，Sex=nan

- 相对稳定的、反映历史变化的：不像关系型数据库，增删改后就没了数据记录，会保留下来变化日志



TiDB用来替代MySQL，用在OLAP中，但在大数据中用的非常少，后续技术选型中再说

## 发展历史

萌芽阶段1978-1988：需要将业务处理系统和分析系统分开，但还做不到

- 数据处理能力还不够，MySQL刚出来，Oracle还没出来

探索阶段1988：定义分析系统四部分，数据获取、数据访问、目录和用户服务

雏形阶段1988：IBM提出信息仓库及其规范，数据抽取、转换、有效性验证、加载、Cube开发、图像化查询工具（**ETL**，抽取、转换、加载）

确立阶段

- 1991： 比尔·恩门，数据仓库之父《building the data warehouse》，得到数据仓库，生成后续的表（数据集市）**按照范式建模，关联表的效率太低**

  <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723151849328.png" alt="image-20230723151849328" style="zoom:50%;" />

- 1994：拉尔夫·金博尔，《the data warehouse toolkit》，补充数据集市概念，多个数据集市构成数据仓库，按照**维度（反范式化）建模**，一个业务一个业务聚合，加快分析效率，但可能存在各个数据集市的数据不一致，集成关联出问题

  <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723151834764.png" alt="image-20230723151834764" style="zoom:50%;" />

  维度建模主要面向数据分析（OLAP）而不是增删改查（OLTP，RDB的操作），包含**事实表和维度表**

  - 事实表：包含维度列（面向的对象）和度量列（用以统计聚合）；列数据只存代号，不存名称，从而减少内存，加快表的关联；fact开头表示

    <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723152316789.png" alt="image-20230723152316789" style="zoom:50%;" />

  - 维度表：每个维度列都有对应的维度表，其将维度列对应代号，用来关联对应信息（维度表中的ID相当于主键）；dim开头表示

    <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723153800731.png" alt="image-20230723153800731" style="zoom:50%;" />

  - Cube开发：将维度列任意组合，进行度量列的统计查询

  - 数据分析模型：包括星型模型、雪花模型

    星型模型：维度表存在一定的信息冗余，但只需要关联一层就能进行度量的分析查询，优先使用该模型

    <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723154747952.png" alt="image-20230723154747952" style="zoom:50%;" />

    雪花模型：一层维度表又分出更多层的维度表，数据冗余少，但进行度量的分析查询时要关联多层，效率低（属于范式建模）

    <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723155248691.png" alt="image-20230723155248691" style="zoom:50%;" />

    星座模型：两张事实表，存在共用的维度表，本质上是星型模型

    <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723155515996.png" alt="image-20230723155515996" style="zoom: 33%;" />

    > 使用维度建模构建用户订单模型
    >
    > <img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723155718805.png" alt="image-20230723155718805" style="zoom: 50%;" />

- 比尔·恩门提出CLF架构：数仓分层，不同层采用不同建模方式

  

## 数据仓库分层

DM层（数据集市层）：基于DW上的基础数据，整合汇总成分析某**一个主题域的报表数据**

DW层：

- DWS层（数据服务层）：按照主题业务组织主题宽表（拼接关联不同的维度表）,用于OLAP分析（如将订单表和产品表等关联）
- DWM层（数据中间层）：对**通用的维度进行轻度聚合操作,**计算相应的统计指标,方便复用（如对某天用户的订单量）
- DWD层（数据明细层）：保证数据质量/ODS的基础上对数据进行**加工处理,**提供更干净的数据

ODS层（操作数据层）：直接存放业务系统抽取过来的数据（不同数据源）,将不同业务系统**中的数据汇聚在同一个存储系统中**（不需要数据清洗）	

<img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723163143489.png" alt="image-20230723163143489" style="zoom:50%;" />

补充说明

- 每层命名方式可能不同，但目的相同；DWM，DWS可能只有一个
- ODS存储原始数据，便于数据的溯源，检查聚合过程是否出错
- ODS、DWD都是范式建模的数据，DWM，DWS，DM层都是**维度建模的数据**

- 数据分层的好处
  - 清晰的数据结构 
  - 减少重复开发，可以复用数据
  - 规范化，统一的数据报表出口
  - 简化分解问题

## 数据仓库实战

案例：某购物网站用户可以在pc端、ipad、手机app端、微信小程序登录购物网站进行购物，用户购物会产生一些订单、浏览商品、地域登录登出等日志数据。为方便后期分析用户日志数据和订单数据更好的辅助决策,设计数仓分层。

各层数据表的设计

<img src="C:\Users\lenovo\Desktop\找工作\大数据开发\assets\image-20230723164648853.png" alt="image-20230723164648853" style="zoom:50%;" />

表的存储

- 大部分公司使用Hive存储，其次是数据湖和Kafka、TiDB很少用	
- 使用数据采集技术进行离线或实时日志数据的采集
  - 离线数据采集：SQOOP、DataX、Kettle
  - 实时数据采集：Flume、Maxwell、Canal、Nifi